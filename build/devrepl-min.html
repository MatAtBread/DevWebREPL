<title>MicroPython WebREPL</title><style>body{background-color:#666;font-family:sans-serif}.python{display:none}#term{background-color:#fff;font-family:monospace;width:100%;height:10em;overflow-y:scroll}#controls{position:relative;top:-4em;float:right}#controls>*{display:block;margin:.3em}.codeArea{border-top:0;display:block;background-color:#333;color:#adff2f;font-family:monospace;width:100%;height:calc(100% - 24em);overflow-y:scroll}#pos{font-family:monospace;float:right;color:#dd6}#cwd{width:fit-content;color:#000;background-color:#fff;display:inline-block;margin:0;padding:0 4px;border-width:0;font-size:.9em}#processing{padding:0 .3em;margin-right:1em;float:right}#file-boxes{position:absolute;bottom:.5em;width:99%}.file-box{margin:4px;padding:4px;background:#aaa}.popup{position:absolute;top:3em;left:5em;border:1px solid;padding:1em;box-shadow:3px 3px 3px #aaa;background-color:#fff;overflow:scroll;min-width:10em;min-height:3em;max-width:calc(100% - 10em);max-height:calc(100% - 8em)}.close{float:right;position:relative;top:-1em;right:-.8em;cursor:pointer;color:#a00}#tabs .close{padding-left:.3em;top:-.05em;right:-.2em}#tabs .close:hover{color:red}#tabs{display:inline-block;vertical-align:middle;height:1.3em;max-height:1.3em;overflow-x:hidden;white-space:nowrap;width:99%}#tabs>.selected{background-color:#333;color:#fff}#tabs>*{display:inline-block;color:#ccc;padding:.2em .5em;font-size:.8em;margin-right:.5em;cursor:default}</style><div style=height:2em><input name=webrepl_url id=url value=ws://192.168.0.128:8266/ > <input type=password id=password> <input type=submit id=button value=Connect onclick=startConnect()><div id=processing style=display:none;color:#ff0>processing...</div></div><div id=tabs><button style=color:#000 onclick=createTab()>+</button></div><textarea class=codeArea spellcheck=false id=code></textarea><div><button onclick=runCode()>Run Code</button> <button onclick=getHelp()>Help</button><div id=pos></div></div><pre id=term>
</pre><div id=controls><button onclick='ui("term").innerHTML=""'>clear</button> <button onclick=ControlC()>Ctr-C</button></div><div id=file-boxes><div class=file-box><span>Load a local file:</span> (send to device<input type=checkbox id=file-to-device>)<input type=file id=load-file></div><div class=file-box><span>Device files:</span> <span id=cwd></span> <select id=device-files onchange=navigateFiles()></select> <input type=button value="Get from device" onclick='getFileFromDevice(ui("device-files").value.substring(1))'> &#10132;<span style="padding:0 1em">terminal</span> &#10132; <input type=button value="Send to device" id=put-file-button onclick='saveFileToDevice(ui("send-file-name").value)'> <input id=send-file-name> <input type=button value="Delete from device" id=delete-file-button onclick=deleteFile()></div></div><script>"use strict";function dict_keys(e){return e}(function(exports){let Wait;var log,code,mPyDevice,ws;async function WebREPLDevice(e,t,n,s){let o=Wait.Unknown,i="";const r={response:null,async waitFor(e,t){for(Array.isArray(e)||(e=[e]);r.response;)await raiseError("Device is busy processing");const n=o;o=t,s?.(t);try{const t=new Promise(((t,n)=>r.response={reject:n,resolve:t,expect:e.map((e=>e.trim())),result:[]}));r.response.pr=t;const a=await t;return{result:r.response.result.join("\n"),found:a}}finally{r.response=null,i="",o=n,s?.()}},untilIdle:()=>r.response?.pr,async send(t,n){e.send(t+"\r\n"),await r.waitFor([t],Wait.Echo);const{result:s}=await r.waitFor([n],Wait.Result);return s},handleStringResponse(e){if("string"==typeof e.data){let n=i+e.data;if(n.indexOf("\r\n")<0){let n;i+=e.data,r.response&&(n=r.response.expect.indexOf(i.trim()))>=0&&(t(i.trim(),o),r.response.resolve(n))}else{const e=n.split("\r\n");i="";for(const n of e){const e=n.trim();if(e&&(t(e,o),r.response)){let t=r.response.expect.indexOf(e.trim());t>=0?r.response.resolve(t):r.response.result.push(e)}}}}},async executeCode(t){const n=t.split("\n").filter((e=>e));if(0===n.length)return"";for(;r.response;)await raiseError("Device is busy processing");if(1===n.length)return r.send(n[0],">>>");e.send(""),await r.waitFor("===",Wait.Prompt);for(const e of n)e&&await r.send(e,"===");return e.send(""),(await r.waitFor(">>>",Wait.Prompt)).result},putFile(t,n,s){let o;return n instanceof Uint8Array?o=n:"string"==typeof n?o=Uint8Array.from([...n].map((e=>e.charCodeAt(0)))):n instanceof ArrayBuffer&&(o=new Uint8Array(n)),new Promise(((n,i)=>{let r=11;const a=o.length,c=new Uint8Array(82);c[0]="W".charCodeAt(0),c[1]="A".charCodeAt(0),c[2]=1,c[3]=0,c[4]=0,c[5]=0,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=0,c[11]=0,c[12]=255&a,c[13]=a>>8&255,c[14]=a>>16&255,c[15]=a>>24&255,c[16]=255&t.length,c[17]=t.length>>8&255;for(let e=0;e<64;++e)e<t.length?c[18+e]=t.charCodeAt(e):c[18+e]=0;e.addEventListener("message",(function t(a){try{function c(e){return e[0]=="W".charCodeAt(0)&&e[1]=="B".charCodeAt(0)?e[2]|e[3]<<8:-1}if(a.data instanceof ArrayBuffer){const l=new Uint8Array(a.data);switch(r){case 11:if(0==c(l)){for(let u=0;u<o.length;u+=1024)e.send(o.slice(u,u+1024)),s?.(u);r=12}break;case 12:e.removeEventListener("message",t),0==c(l)?(s?.(o.length),n()):i(new Error("Send failed")),r=0}}}catch(d){e.removeEventListener("message",t),i(d)}})),e.send(c)}))},getFile(t,n){let s=new Uint8Array(0);return new Promise(((o,i)=>{let r=21;const a=new Uint8Array(82);a[0]="W".charCodeAt(0),a[1]="A".charCodeAt(0),a[2]=2,a[3]=0,a[4]=0,a[5]=0,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=0,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=0,a[16]=255&t.length,a[17]=t.length>>8&255;for(let e=0;e<64;++e)e<t.length?a[18+e]=t.charCodeAt(e):a[18+e]=0;e.addEventListener("message",(function t(a){try{function c(e){return e[0]=="W".charCodeAt(0)&&e[1]=="B".charCodeAt(0)?e[2]|e[3]<<8:-1}if(a.data instanceof ArrayBuffer){const l=new Uint8Array(a.data);switch(r){case 21:if(0==c(l)){r=22;const u=new Uint8Array(1);u[0]=0,e.send(u)}break;case 22:{const d=l[0]|l[1]<<8;if(l.length==2+d)if(0==d)r=23;else{const p=new Uint8Array(s.length+d);p.set(s),p.set(l.slice(2),s.length),s=p,n?.(s.length);const f=new Uint8Array(1);f[0]=0,e.send(f)}else r=0;break}case 23:e.removeEventListener("message",t),0==c(l)?(n?.(s.length),o(s)):i(new Error("Receive file failed")),r=0}}}catch(v){e.removeEventListener("message",t),i(v)}})),e.send(a)}))}};return e.addEventListener("message",r.handleStringResponse),await r.waitFor("Password:",Wait.Connect),e.send(n+"\n"),r}function connect(e,t){return new Promise(((n,s)=>{function o(e){mPyDevice=null,console.log({disconnect:e}),log("Device disconnected",Wait.Connect),s(new Error("Device disconnected"))}(ws=new WebSocket(e)).binaryType="arraybuffer",ws.addEventListener("open",(async function(){const e=ui("processing");mPyDevice=await WebREPLDevice(ws,((e,t)=>log(e,t)),t,(t=>{e.style.backgroundColor=t||"",e.style.display=t?"inline-block":"none"}));const o=await mPyDevice.waitFor(["WebREPL connected","Access denied"],Wait.Connect);if(1===o.found)return ws.close(),alert("Incorrect password. Please try again"),void s(o);n(ws)})),ws.addEventListener("close",o),ws.addEventListener("error",o)}))}function popup(e=""){let t;const n=document.createElement("pre");return n.className="popup","string"==typeof e?(n.innerHTML=`<div class="close">×</div><span>${e.replace(/[\u00A0-\u9999<>\&]/g,(e=>"&#"+e.charCodeAt(0)+";"))}</span>`,t=n.lastElementChild):(n.innerHTML='<div class="close">×</div>',n.append(e),t=e),n.querySelector(".close").onclick=()=>{n.remove()},document.body.append(n),{update(e){t.textContent=e},close(){n.remove()}}}function raiseError(e){if(confirm(e+"\n\nDo you want to re-connect?"))return ws?.close(),mPyDevice=null,startConnect();throw new Error(e)}function onload(){const e=window.location.hash.substring(1).split("~");e[0]&&(ui("url").value="ws://"+e[0]);const t=ui("term");log=(e,n)=>{const s=document.createElement("div");s.style.color=n,s.textContent=e,t.append(s),t.scrollTop=Number.MAX_SAFE_INTEGER};const n=ui("code");function s(){localStorage[ui("tabs")?.querySelector(".selected")?.id||"code"]=code.getValue()}n.onkeydown=async e=>{if("F1"===e.key)e.preventDefault(),await getHelp();else if("Tab"===e.key){let t=n.selectionStart,o=n.selectionEnd;const i=n.value.substring(0,t).split("\n").length-1,r=n.value.substring(0,o).split("\n").length-1;if(i===r){const e=n.value.substring(0,t),s=1&e.split("\n").pop().length?3:2;n.value=e+" ".repeat(s)+n.value.substring(t),n.selectionStart=n.selectionEnd=t+s}else{const s=n.value.split("\n");for(let t=i;t<r+1;t++)e.shiftKey?s[t].startsWith("  ")?(s[t]=s[t].substring(2),o-=2):s[t].startsWith(" ")&&(s[t]=s[t].substring(1),o-=1):(s[t]="  "+s[t],o+=2);n.value=s.join("\n"),n.selectionStart=t,n.selectionEnd=o}e.preventDefault(),s()}},n.onkeyup=n.onmouseup=()=>{var e=n.value.substring(0,n.selectionStart).split("\n"),t=e.length,s=e[e.length-1].length;ui("pos").textContent=`Line: ${t}, col: ${s}`},(code={getSelectedText(){const e=n.selectionStart,t=n.selectionEnd;return e==t?n.value:n.value.substring(e,t)},setValue(e){n.value=e},getValue:()=>n.value,focus:()=>n.focus(),on(e,t){n.onchange=t}}).on("change",s),lastTab=0;for(const[e,t]of Object.entries(localStorage))e.startsWith("tab:")&&(e.startsWith("tab:Unsaved")&&(lastTab+=1),createTab(e.slice(4),t));if(0===lastTab&&(lastTab=1,createTab(),code.setValue(localStorage.code||"")),"https:"===window.location.protocol){const e=document.createElement("div");e.innerHTML='At this time, the WebREPL client cannot be accessed over HTTPS connections.<br>Use a HTTP connection, eg. <a href="http://micropython.org/webrepl/">http://micropython.org/webrepl/</a>.<br>Alternatively, download the files from <a href="https://github.com/micropython/webrepl">GitHub</a> and run them locally.<br>',popup(e)}ui("load-file").addEventListener("click",(function(){this.value=""}),!1),ui("load-file").addEventListener("change",(function(e){const t=this.files;if(!t)return alert("No files selected");const n=t[0],s=new FileReader;s.onload=async function(e){if(!this.result)throw new Error("Failed to load file");if(ui("file-to-device").checked){const e=prompt("File name on device?",n.name);null!==e&&(await(mPyDevice?.putFile(e,this.result)),createTab("🁡 "+e,this.result.toString()))}else createTab("🖥 "+n.name,this.result.toString())},s.readAsText(n)}),!1)}async function ControlC(){ws&&mPyDevice&&(await new Promise((e=>setTimeout(e,500))),mPyDevice.response?.reject(new Error("Interrupted")),mPyDevice.response=null,ws.send(""),mPyDevice.waitFor(">>>",Wait.Unknown))}async function runCode(){for(;!mPyDevice;)await raiseError("Device not connected");code.focus();const e=code.getSelectedText();return await mPyDevice.executeCode(e)}async function startConnect(){function e(){ui("url").disabled=!1,ui("button").value="Connect"}mPyDevice&&(mPyDevice.response?.reject(new Error("Interrupted")),mPyDevice.response=null,mPyDevice=null,ws.close()),ui("url").disabled=!0,ui("button").value="Disconnect";const t=ui("url").value;try{(await connect(t,ui("password").value)).addEventListener("close",e),window.location.hash=t.substring(5),await populateFileList()}catch(t){e()}}async function getHelp(){code.focus();const e=code.getSelectedText();e&&popup(await(mPyDevice?.executeCode(`help((${e}))`)))}async function navigateFiles(){const e=ui("device-files");for(;!mPyDevice;)await raiseError("Not connected");let t=e.value;"/"===t[0]||".."===t?("/"!=t&&".."!==t&&(t=t.substring(1)),await mPyDevice.executeCode(`import os\nos.chdir('${t}')`),await populateFileList()):ui("send-file-name").value=t.substring(1)}async function populateFileList(){const select=ui("device-files");for(;!mPyDevice;)await raiseError("Not connected");const script="import os\ndir = []\nfor i in os.listdir():\n  dir.append([i,list(os.stat(i))])\n[os.getcwd(),dir]",result=await mPyDevice.executeCode(script);let[cwd,files]=eval(result);ui("cwd").textContent=cwd,select.innerHTML="",files=files.map((e=>{const t=16384&e[1][0];return e[0]=(t?"/":" ")+e[0],e})),files.sort(((e,t)=>e[0]>t[0]?1:e[0]<t[0]?-1:0)),"/"!==cwd&&(files=[["/",[32768]],["..",[32768]],...files]);for(const e of files){const t=document.createElement("option");t.textContent=e[0],select.append(t)}return select.selectedIndex=-1,script}async function deleteFile(){for(;!mPyDevice;)await raiseError("Not connected");const e=ui("cwd").textContent,t=("/"===e?"":e)+"/"+ui("send-file-name").value;confirm(`Delete ${t} from device?`)&&(await mPyDevice.executeCode(`import os\nos.unlink('${t}')\n`),await populateFileList())}async function saveFileToDevice(e,t=code.getValue()){const n=popup("Sending "+e+"...");try{await mPyDevice.putFile(e,t,(t=>n.update("Sent "+e+", "+t+" bytes"))),n.close()}catch(t){n.update(t+" "+e)}}async function getFileFromDevice(e){const t=popup("Getting "+e+"...");try{const n=await mPyDevice.getFile(e,(n=>t.update("Read "+e+", "+n+" bytes"))),s=ui("cwd").textContent;createTab("🁡 "+("/"===s?"":s)+"/"+e,(new TextDecoder).decode(n)),t.close()}catch(n){t.update(n+" "+e)}}let lastTab;function createTab(e,t=code.getValue()){if(!e){for(;document.getElementById("tab:Unsaved "+lastTab);)lastTab+=1;e="Unsaved "+lastTab++}const n=document.getElementById("tab:"+e);if(n)return n.saved=t,n.classList.contains("selected")||n.select(),n;const s=document.createElement("span");s.id="tab:"+e,s.innerHTML=`${e} <span class="close">&#215;</span>`,s.saved=t,s.onclick=s.select=function(e){if(e?.preventDefault(),!this.parentElement)return;const t=ui("tabs").querySelector(".selected");t!==this&&(t&&(t.saved=code.getValue(),t.classList.remove("selected")),this.classList.add("selected"),code.setValue(this.saved||"")),e&&code.focus()},s.querySelector(".close").onclick=function(e){e.preventDefault();const t=s.nextElementSibling||s.previousElementSibling;delete localStorage[s.id],s.remove(),t?.select?t.select():createTab()},ui("tabs").append(s),s.select(),localStorage[s.id]=code.getValue()}function ui(e){const t=document.getElementById(e);if(!t)throw new Error("Missing UI element: "+e);return t}var e;e=Wait||(Wait={}),e.Connect="red",e.Prompt="blue",e.Echo="green",e.Result="black",e.Unknown="magenta",Object.assign(exports,{onload:onload,ui:ui,getFileFromDevice:getFileFromDevice,saveFileToDevice:saveFileToDevice,deleteFile:deleteFile,navigateFiles:navigateFiles,getHelp:getHelp,startConnect:startConnect,runCode:runCode,ControlC:ControlC,createTab:createTab})})(window)</script>